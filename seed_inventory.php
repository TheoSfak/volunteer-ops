<?php
/**
 * VolunteerOps - Εισαγωγή Υλικών Αποθέματος (Production)
 * 
 * Εισάγει 46 υλικά, 7 κατηγορίες, 12 τοποθεσίες από τα δεδομένα του localhost.
 * Ασφαλές για επανεκτέλεση - χρησιμοποιεί ON DUPLICATE KEY / IF NOT EXISTS.
 * 
 * Τρέξτε μία φορά στο production: https://yphresies.gr/seed_inventory.php
 * Μετά διαγράψτε το αρχείο.
 */

require_once __DIR__ . '/bootstrap.php';
requireLogin();
requireRole([ROLE_SYSTEM_ADMIN]);

// Check inventory tables exist
if (!inventoryTablesExist()) {
    echo "<h2>❌ Οι πίνακες αποθέματος δεν υπάρχουν. Τρέξτε πρώτα το <a href='migrate_v3.php'>migrate_v3.php</a></h2>";
    exit;
}

$pageTitle = 'Εισαγωγή Υλικών Αποθέματος';
$results = [];
$errors = [];

if (isPost()) {
    verifyCsrf();
    
    $pdo = getDb();
    
    // =============================================
    // 1. Εύρεση ή δημιουργία Παραρτήματος Ηρακλείου
    // =============================================
    $dept = dbFetchOne("SELECT id FROM departments WHERE has_inventory = 1 AND name LIKE '%Ηράκλειο%' LIMIT 1");
    if (!$dept) {
        // Try any inventory department
        $dept = dbFetchOne("SELECT id FROM departments WHERE has_inventory = 1 LIMIT 1");
    }
    if (!$dept) {
        // Create one
        $deptId = dbInsert(
            "INSERT INTO departments (name, description, has_inventory) VALUES (?, ?, 1)",
            ['Ηράκλειο', 'Παράρτημα Ηρακλείου']
        );
        $results[] = "Δημιουργήθηκε Παράρτημα: Ηράκλειο (ID: {$deptId})";
    } else {
        $deptId = $dept['id'];
        $results[] = "Βρέθηκε υπάρχον Παράρτημα (ID: {$deptId})";
    }
    
    // =============================================
    // 2. Εισαγωγή Κατηγοριών
    // =============================================
    $categories = [
        ['Φαρμακεία',            'Ιατρικά φαρμακεία και φάρμακα',                  '💊', '#dc3545', 1],
        ['Ιατρικός Εξοπλισμός',  'Ιατρικά όργανα και συσκευές',                    '🏥', '#28a745', 2],
        ['Διαφημιστικό Υλικό',   'Υλικό για δημοσιότητα και ενημέρωση',            '📢', '#17a2b8', 3],
        ['Ασύρματοι',            'Εξοπλισμός επικοινωνιών για δραστηριότητες',      '📡', '#007bff', 4],
        ['Φορεία',               'Φορεία μεταφοράς και σανίδες ακινητοποίησης',    '🚑', '#e83e8c', 5],
        ['Μπάνερ',               'Μπάνερ διαφημιστικά',                            '📋', '#6c757d', 6],
        ['Εκπαιδευτικό Υλικό',   'Κούκλες CPR και εκπαιδευτικά όργανα',            '📚', '#ffc107', 7],
    ];
    
    $catMap = []; // name => id
    foreach ($categories as $cat) {
        $existing = dbFetchOne("SELECT id FROM inventory_categories WHERE name = ?", [$cat[0]]);
        if ($existing) {
            $catMap[$cat[0]] = $existing['id'];
        } else {
            $catMap[$cat[0]] = dbInsert(
                "INSERT INTO inventory_categories (name, description, icon, color, sort_order, is_active) VALUES (?, ?, ?, ?, ?, 1)",
                [$cat[0], $cat[1], $cat[2], $cat[3], $cat[4]]
            );
        }
    }
    $results[] = "Κατηγορίες: " . count($catMap) . " (OK)";
    
    // =============================================
    // 3. Εισαγωγή Τοποθεσιών
    // =============================================
    $locations = [
        ['Κεντρική Αποθήκη',          'warehouse', 'Κύρια αποθήκη υλικών κεντρικού κτιρίου'],
        ['Αποθήκη Ορειβασίας',        'warehouse', 'Αποθήκη εξοπλισμού τμήμα ορειβασίας'],
        ['Αποθήκη Οχημάτων',          'vehicle',   'Αποθήκη εντός οχημάτων'],
        ['Αποθήκη Εκτάκτων Αναγκών',  'warehouse', 'Αποθήκη εξοπλισμού εκτάκτων αναγκών'],
        ['Ιατρικό Τμήμα',             'room',      'Ιατρείο και χώρος ιατρικού εξοπλισμού'],
        ['Κέντρο Υποδοχής',           'room',      'Κέντρο υποδοχής μεταναστών'],
        ['Μονάδα Διάσωσης',           'room',      'Μονάδα διάσωσης και εξοπλισμού'],
        ['Ιατρείο',                   'room',      'Ιατρείο - προσωπικός χώρος ιατρού'],
        ['Κεντρικός Διάδρομος',       'room',      'Κεντρικός διάδρομος κτιρίου'],
        ['Αποθήκη Διάσωσης',          'warehouse', 'Αποθήκη εξοπλισμού διάσωσης'],
        ['Αποθήκη Εξοπλισμού',        'warehouse', 'Γενική αποθήκη εξοπλισμού και επικοινωνιών'],
        ['Τμήμα Ηρακλείου',           'room',      'Τμήμα Ηρακλείου - αποθήκη εξοπλισμού'],
    ];
    
    $locMap = []; // name => id
    foreach ($locations as $loc) {
        $existing = dbFetchOne("SELECT id FROM inventory_locations WHERE name = ?", [$loc[0]]);
        if ($existing) {
            $locMap[$loc[0]] = $existing['id'];
        } else {
            $locMap[$loc[0]] = dbInsert(
                "INSERT INTO inventory_locations (name, department_id, location_type, notes) VALUES (?, ?, ?, ?)",
                [$loc[0], $deptId, $loc[1], $loc[2]]
            );
        }
    }
    $results[] = "Τοποθεσίες: " . count($locMap) . " (OK)";
    
    // =============================================
    // 4. Εισαγωγή Υλικών (46 items)
    // =============================================
    // Format: [barcode, name, description, category_name, location_name, location_notes, status]
    $items = [
        ['UB001', 'ΥΒ1 (Υποστηρικτικά)', 'Φαρμακείο υποστηρικτικών δραστηριοτήτων - Περιέχει βασικά φάρμακα, επιδέσμους και υλικά πρώτων βοηθειών για υποστήριξη εκδηλώσεων', 'Φαρμακεία', 'Κεντρική Αποθήκη', 'Αποθήκη κεντρικού κτιρίου, ράφι Α1', 'available', '2025-08-19 12:00:00'],
        ['UB002', 'ΥΒ2 (Υποστηρικτικά)', 'Φαρμακείο υποστηρικτικών δραστηριοτήτων - Δευτερεύον φαρμακείο με συμπληρωματικά υλικά για μεγάλες εκδηλώσεις', 'Φαρμακεία', 'Κεντρική Αποθήκη', 'Αποθήκη κεντρικού κτιρίου, ράφι Α2', 'available', '2025-08-19 12:00:00'],
        ['UB003', 'ΥΒ3 (Υποστηρικτικά)', 'Φαρμακείο υποστηρικτικών δραστηριοτήτων - Τρίτο φαρμακείο υποστήριξης με εξειδικευμένα υλικά', 'Φαρμακεία', 'Κεντρική Αποθήκη', 'Αποθήκη κεντρικού κτιρίου, ράφι Α3', 'available', '2025-08-19 12:00:00'],
        ['UB004', 'ΥΒ4 (Υποστηρικτικά)', 'Φαρμακείο υποστηρικτικών δραστηριοτήτων - Εφεδρικό φαρμακείο για έκτακτες ανάγκες και backup', 'Φαρμακεία', 'Κεντρική Αποθήκη', 'Αποθήκη κεντρικού κτιρίου, ράφι Α4', 'available', '2025-08-19 12:00:00'],
        
        ['OR001', 'Ο1 (Ορειβατικά)', 'Ειδικό φαρμακείο για ορειβατικές δραστηριότητες - Περιέχει φάρμακα για τραυματισμούς, υποθερμία και ορειβατικά ατυχήματα', 'Φαρμακεία', 'Αποθήκη Ορειβασίας', 'Αποθήκη εξοπλισμού, τμήμα ορειβασίας, ράφι Β1', 'available', '2025-08-19 12:00:00'],
        ['OR002', 'Ο2 (Ορειβατικά)', 'Δευτερεύον φαρμακείο ορειβασίας - Συμπληρωματικό kit με αναλγητικά και αντιφλεγμονώδη για ορειβατικές αποστολές', 'Φαρμακεία', 'Αποθήκη Ορειβασίας', 'Αποθήκη εξοπλισμού, τμήμα ορειβασίας, ράφι Β2', 'available', '2025-08-19 12:00:00'],
        ['OR003', 'Ο3 (Ορειβατικά)', 'Τρίτο φαρμακείο ορειβασίας - Εξειδικευμένο kit για δύσκολες αποστολές και διάσωση σε ορεινά', 'Φαρμακεία', 'Αποθήκη Ορειβασίας', 'Αποθήκη εξοπλισμού, τμήμα ορειβασίας, ράφι Β3', 'available', '2025-08-19 12:00:00'],
        ['OR004', 'Ο4 (Ορειβατικά)', 'Τέταρτο φαρμακείο ορειβασίας - Εφεδρικό kit για παρατεταμένες ορειβατικές αποστολές', 'Φαρμακεία', 'Αποθήκη Ορειβασίας', 'Αποθήκη εξοπλισμού, τμήμα ορειβασίας, ράφι Β4', 'available', '2025-08-19 12:00:00'],
        
        ['PAT001', 'Π1 (Περιπολίας)', 'Φαρμακείο περιπολίας - Compact kit για καθημερινές περιπολίες με βασικά φάρμακα και επιδέσμους', 'Φαρμακεία', 'Αποθήκη Οχημάτων', 'Αποθήκη οχημάτων, ράφι Γ1', 'available', '2025-08-19 12:00:00'],
        ['PAT002', 'Π2 (Περιπολίας)', 'Δεύτερο φαρμακείο περιπολίας - Backup kit για ταυτόχρονες περιπολίες και εφημερίες', 'Φαρμακεία', 'Αποθήκη Οχημάτων', 'Αποθήκη οχημάτων, ράφι Γ2', 'available', '2025-08-19 12:00:00'],
        ['PAT003', 'Π3 (Περιπολίας)', 'Τρίτο φαρμακείο περιπολίας - Εξειδικευμένο kit για νυχτερινές και εκτεταμένες περιπολίες', 'Φαρμακεία', 'Αποθήκη Οχημάτων', 'Αποθήκη οχημάτων, ράφι Γ3', 'available', '2025-08-19 12:00:00'],
        ['PAT004', 'Π4 (Περιπολίας)', 'Τέταρτο φαρμακείο περιπολίας - Εφεδρικό kit για έκτακτες περιπολίες και καλύψεις', 'Φαρμακεία', 'Αποθήκη Οχημάτων', 'Αποθήκη οχημάτων, ράφι Γ4', 'available', '2025-08-19 12:00:00'],
        
        ['MPAT001', 'ΜΠ1 (Μεγάλα Περιπολίας)', 'Μεγάλο φαρμακείο περιπολίας - Εκτεταμένο kit για μεγάλες περιπολίες και επιχειρήσεις διάσωσης', 'Φαρμακεία', 'Αποθήκη Εκτάκτων Αναγκών', 'Αποθήκη εκτάκτων αναγκών, ράφι Δ1', 'available', '2025-08-19 12:00:00'],
        ['MPAT002', 'ΜΠ2 (Μεγάλα Περιπολίας)', 'Δεύτερο μεγάλο φαρμακείο περιπολίας - Συμπληρωματικό kit για μεγάλες επιχειρήσεις και καταστροφές', 'Φαρμακεία', 'Αποθήκη Εκτάκτων Αναγκών', 'Αποθήκη εκτάκτων αναγκών, ράφι Δ2', 'available', '2025-08-19 12:00:00'],
        ['MPAT003', 'ΜΠ3 (Μεγάλα Περιπολίας)', 'Τρίτο μεγάλο φαρμακείο περιπολίας - Εφεδρικό kit για παρατεταμένες επιχειρήσεις και στρατόπεδα', 'Φαρμακεία', 'Αποθήκη Εκτάκτων Αναγκών', 'Αποθήκη εκτάκτων αναγκών, ράφι Δ3', 'available', '2025-08-19 12:00:00'],
        
        ['BLS001', 'BLS1', 'Basic Life Support Kit 1 - Εξειδικευμένο φαρμακείο BLS με φάρμακα καρδιοπνευμονικής αναζωογόνησης και έκτακτης ιατρικής', 'Φαρμακεία', 'Ιατρικό Τμήμα', 'Ιατρικό τμήμα, ράφι Ε1', 'maintenance', '2025-08-19 12:00:00'],
        ['BLS002', 'BLS2', 'Basic Life Support Kit 2 - Δευτερεύον BLS kit με αναλγητικά, αντιφλεγμονώδη και φάρμακα τραύματος', 'Φαρμακεία', 'Ιατρικό Τμήμα', 'Ιατρικό τμήμα, ράφι Ε2', 'available', '2025-08-19 12:00:00'],
        ['BLS003', 'BLS3', 'Basic Life Support Kit 3 - Τρίτο BLS kit για backup και ταυτόχρονες επιχειρήσεις διάσωσης', 'Φαρμακεία', 'Ιατρικό Τμήμα', 'Ιατρικό τμήμα, ράφι Ε3', 'available', '2025-08-19 12:00:00'],
        
        ['REF001', 'Μεταναστών', 'Ειδικό φαρμακείο για υποστήριξη μεταναστών - Περιέχει φάρμακα για συχνές παθήσεις, υποσιτισμό και ψυχολογική υποστήριξη', 'Φαρμακεία', 'Κέντρο Υποδοχής', 'Κέντρο υποδοχής, ιατρείο', 'available', '2025-08-19 12:00:00'],
        ['RES001', 'Rescue 1', 'Φαρμακείο διάσωσης - Εξειδικευμένο kit για επιχειρήσεις έρευνας και διάσωσης με φάρμακα τραύματος και σοκ', 'Φαρμακεία', 'Μονάδα Διάσωσης', 'Μονάδα διάσωσης, ράφι ΣΤ1', 'available', '2025-08-19 12:00:00'],
        ['DOC001', 'Φ.Ιατρού', 'Φαρμακείο ιατρού - Προσωπικό φαρμακείο του ιατρού με εξειδικευμένα φάρμακα και εργαλεία διάγνωσης', 'Φαρμακεία', 'Ιατρείο', 'Ιατρείο, προσωπικό ντουλάπι', 'available', '2025-08-19 12:00:00'],
        
        ['AED001', 'Απινιδωτής Πράσινος', 'Αυτόματος εξωτερικός απινιδωτής (AED) - Πράσινη συσκευή για καρδιοπνευμονική αναζωογόνηση και άμεση παρέμβαση σε καρδιακή ανακοπή', 'Ιατρικός Εξοπλισμός', 'Κεντρικός Διάδρομος', 'Κεντρικός διάδρομος, τοίχος εισόδου', 'available', '2025-08-19 12:35:00'],
        ['AED002', 'Απινιδωτής Μαύρος', 'Αυτόματος εξωτερικός απινιδωτής (AED) - Μαύρη συσκευή για επιχειρήσεις διάσωσης και εξωτερικές αποστολές', 'Ιατρικός Εξοπλισμός', 'Μονάδα Διάσωσης', 'Μονάδα διάσωσης, φορητή τσάντα', 'available', '2025-08-19 12:35:00'],
        
        ['STR001', 'Σπαστό1', 'Φορείο σπαστό νούμερο 1 - Φορητό αναδιπλούμενο φορείο για μεταφορά τραυματιών σε δύσκολες συνθήκες', 'Φορεία', 'Αποθήκη Διάσωσης', 'Αποθήκη διάσωσης, ράφι Φ1', 'available', '2025-08-19 12:40:00'],
        ['STR002', 'Σπαστό2', 'Φορείο σπαστό νούμερο 2 - Δευτερεύον φορητό φορείο για ταυτόχρονες επιχειρήσεις διάσωσης', 'Φορεία', 'Αποθήκη Διάσωσης', 'Αποθήκη διάσωσης, ράφι Φ2', 'available', '2025-08-19 12:40:00'],
        ['STR003', 'Σπαστό3', 'Φορείο σπαστό νούμερο 3 - Τρίτο φορητό φορείο για εκτεταμένες επιχειρήσεις διάσωσης', 'Φορεία', 'Αποθήκη Διάσωσης', 'Αποθήκη διάσωσης, ράφι Φ3', 'available', '2025-08-19 12:40:00'],
        ['STR004', 'Σπαστό4', 'Φορείο σπαστό νούμερο 4 - Τέταρτο φορητό φορείο για εφεδρικές επιχειρήσεις και backup', 'Φορεία', 'Αποθήκη Διάσωσης', 'Αποθήκη διάσωσης, ράφι Φ4', 'available', '2025-08-19 12:40:00'],
        ['BOA001', 'Σανίδα1', 'Σανίδα ακινητοποίησης νούμερο 1 - Ξύλινη σανίδα για ακινητοποίηση τραυματιών με υποψία κάκωσης σπονδυλικής στήλης', 'Φορεία', 'Αποθήκη Διάσωσης', 'Αποθήκη διάσωσης, κάθετη θέση, τοίχος Α', 'available', '2025-08-19 12:40:00'],
        
        ['ASY001', 'Ασύρματος1', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', 'Αποθήκη Εξοπλισμού', 'Αποθήκη εξοπλισμού, τμήμα επικοινωνιών, θέση Α1', 'available', '2025-08-22 08:54:00'],
        ['ASY002', 'Ασύρματος2', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', 'Αποθήκη Εξοπλισμού', 'Αποθήκη εξοπλισμού, τμήμα επικοινωνιών, θέση Α2', 'available', '2025-08-22 08:54:00'],
        ['ASY003', 'Ασύρματος3', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', 'Αποθήκη Εξοπλισμού', 'Αποθήκη εξοπλισμού, τμήμα επικοινωνιών, θέση Α3', 'available', '2025-08-22 08:54:00'],
        ['ASY004', 'Ασύρματος4', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', 'Αποθήκη Εξοπλισμού', 'Αποθήκη εξοπλισμού, τμήμα επικοινωνιών, θέση Α4', 'available', '2025-08-22 08:54:00'],
        ['ASY005', 'Ασύρματος5', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', 'Αποθήκη Εξοπλισμού', 'Αποθήκη εξοπλισμού, τμήμα επικοινωνιών, θέση Α5', 'available', '2025-08-22 08:54:00'],
        ['ASY006', 'Ασύρματος6', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', 'Αποθήκη Εξοπλισμού', 'Αποθήκη εξοπλισμού, τμήμα επικοινωνιών, θέση Α6', 'available', '2025-08-22 08:54:00'],
        ['ASY007', 'Ασύρματος7', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', 'Αποθήκη Εξοπλισμού', 'Αποθήκη εξοπλισμού, τμήμα επικοινωνιών, θέση Α7', 'available', '2025-08-22 08:54:00'],
        ['ASY008', 'Ασύρματος8', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', 'Αποθήκη Εξοπλισμού', 'Αποθήκη εξοπλισμού, τμήμα επικοινωνιών, θέση Α8', 'available', '2025-08-22 08:54:00'],
        ['ASY009', 'Ασύρματος9', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', 'Αποθήκη Εξοπλισμού', 'Αποθήκη εξοπλισμού, τμήμα επικοινωνιών, θέση Α9', 'available', '2025-08-22 08:54:00'],
        ['ASY010', 'Ασύρματος10', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', 'Αποθήκη Εξοπλισμού', 'Αποθήκη εξοπλισμού, τμήμα επικοινωνιών, θέση Α10', 'available', '2025-08-22 08:54:00'],
        ['ASY011', 'Ασύρματος11', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', 'Αποθήκη Εξοπλισμού', 'Αποθήκη εξοπλισμού, τμήμα επικοινωνιών, θέση Α11', 'available', '2025-08-22 08:54:00'],
        ['ASY012', 'Ασύρματος12', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', 'Αποθήκη Εξοπλισμού', 'Αποθήκη εξοπλισμού, τμήμα επικοινωνιών, θέση Α12', 'available', '2025-08-22 08:54:00'],
        ['ASY013', 'Ασύρματος13', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', 'Αποθήκη Εξοπλισμού', 'Αποθήκη εξοπλισμού, τμήμα επικοινωνιών, θέση Α13', 'available', '2025-08-22 08:54:00'],
        ['ASY014', 'Ασύρματος14', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', 'Αποθήκη Εξοπλισμού', 'Αποθήκη εξοπλισμού, τμήμα επικοινωνιών, θέση Α14', 'available', '2025-08-22 08:54:00'],
        ['ASY015', 'Ασύρματος15', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', 'Αποθήκη Εξοπλισμού', '', 'available', '2025-08-22 09:52:43'],
        ['ASY016', 'Ασύρματος16', 'Ασύρματος πομποδέκτης για επικοινωνία κατά τη διάρκεια δραστηριοτήτων και αποστολών', 'Ασύρματοι', null, '', 'available', '2025-08-23 15:11:08'],
        
        ['GEN001', 'Μπάνερ001', 'Ελληνικός ερυθρός σταυρός ΠΤΗ', 'Μπάνερ', null, '', 'available', '2025-09-04 17:03:52'],
        
        ['2326545787', 'Κουκλα CPR Αννιε', 'Πάγιο εξοπλισμού - Κουκλα CPR Αννιε', 'Εκπαιδευτικό Υλικό', 'Τμήμα Ηρακλείου', null, 'available', '2025-09-03 23:37:59'],
    ];
    
    $inserted = 0;
    $skipped = 0;
    $userId = getCurrentUserId();
    
    foreach ($items as $item) {
        [$barcode, $name, $desc, $catName, $locName, $locNotes, $status, $createdAt] = $item;
        
        // Skip if barcode already exists
        $existing = dbFetchOne("SELECT id FROM inventory_items WHERE barcode = ?", [$barcode]);
        if ($existing) {
            $skipped++;
            continue;
        }
        
        $categoryId = $catMap[$catName] ?? null;
        $locationId = ($locName && isset($locMap[$locName])) ? $locMap[$locName] : null;
        
        dbInsert(
            "INSERT INTO inventory_items 
                (barcode, name, description, category_id, department_id, location_id, location_notes,
                 status, quantity, is_active, created_by, created_at)
             VALUES (?, ?, ?, ?, ?, ?, ?, ?, 1, 1, ?, ?)",
            [$barcode, $name, $desc, $categoryId, $deptId, $locationId, $locNotes ?: null, $status, $userId, $createdAt]
        );
        $inserted++;
    }
    
    $results[] = "Υλικά: {$inserted} εισήχθησαν, {$skipped} ήδη υπήρχαν";
    
    // =============================================
    // 5. Σύνοψη
    // =============================================
    $totalItems = dbFetchValue("SELECT COUNT(*) FROM inventory_items");
    $totalCats  = dbFetchValue("SELECT COUNT(*) FROM inventory_categories");
    $totalLocs  = dbFetchValue("SELECT COUNT(*) FROM inventory_locations");
    
    $results[] = "───────────────────────────────";
    $results[] = "Σύνολο στη βάση: {$totalItems} υλικά, {$totalCats} κατηγορίες, {$totalLocs} τοποθεσίες";
}

include __DIR__ . '/includes/header.php';
?>

<div class="container-fluid">
    <h1 class="h3 mb-4"><i class="bi bi-box-seam me-2"></i>Εισαγωγή Υλικών Αποθέματος</h1>
    
    <?php if (empty($results)): ?>
        <div class="alert alert-info">
            <h5><i class="bi bi-info-circle me-2"></i>Τι θα γίνει:</h5>
            <ul class="mb-0">
                <li><strong>7 κατηγορίες</strong>: Φαρμακεία, Ιατρικός Εξοπλισμός, Διαφημιστικό Υλικό, Ασύρματοι, Φορεία, Μπάνερ, Εκπαιδευτικό Υλικό</li>
                <li><strong>12 τοποθεσίες</strong>: Κεντρική Αποθήκη, Αποθήκη Ορειβασίας, Αποθήκη Οχημάτων, κλπ.</li>
                <li><strong>46 υλικά</strong>: 21 Φαρμακεία, 2 AED, 5 Φορεία/Σανίδες, 16 Ασύρματοι, 1 Μπάνερ, 1 Κούκλα CPR</li>
            </ul>
            <hr>
            <p class="mb-0"><i class="bi bi-shield-check me-2"></i><strong>Ασφαλές:</strong> Παραλείπει υλικά που ήδη υπάρχουν (βάσει barcode). Μπορείτε να το τρέξετε ξανά χωρίς πρόβλημα.</p>
        </div>
        
        <form method="post">
            <?= csrfField() ?>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-database-add me-2"></i>Εισαγωγή Υλικών
            </button>
            <a href="inventory.php" class="btn btn-outline-secondary btn-lg ms-2">Ακύρωση</a>
        </form>
    <?php else: ?>
        <div class="alert alert-success">
            <h5><i class="bi bi-check-circle me-2"></i>Αποτελέσματα:</h5>
            <?php foreach ($results as $r): ?>
                <div><?= h($r) ?></div>
            <?php endforeach; ?>
        </div>
        
        <?php if (!empty($errors)): ?>
            <div class="alert alert-danger">
                <h5><i class="bi bi-x-circle me-2"></i>Σφάλματα:</h5>
                <?php foreach ($errors as $e): ?>
                    <div><?= h($e) ?></div>
                <?php endforeach; ?>
            </div>
        <?php endif; ?>
        
        <div class="alert alert-warning">
            <i class="bi bi-trash me-2"></i><strong>Διαγράψτε αυτό το αρχείο</strong> μετά την εισαγωγή: <code>seed_inventory.php</code>
        </div>
        
        <a href="inventory.php" class="btn btn-success btn-lg">
            <i class="bi bi-box-seam me-2"></i>Μετάβαση στα Υλικά
        </a>
    <?php endif; ?>
</div>

<?php include __DIR__ . '/includes/footer.php'; ?>
